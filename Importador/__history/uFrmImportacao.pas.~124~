unit uFrmImportacao;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, ufrmStandard, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.Buttons, FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.Grids, Vcl.DBGrids, udmConnect, Vcl.ComCtrls,
  Vcl.DBCtrls;

type
  TfrmImportacao = class(TfrmStandard)
    Panel1: TPanel;
    edtCaminhoArquivo: TLabeledEdit;
    sbtCaminhoArquivo: TSpeedButton;
    btnImportar: TButton;
    ddsIMP: TDataSource;
    fqrIMP: TFDQuery;
    Panel2: TPanel;
    btnDesfazerIMP: TButton;
    btnSair: TButton;
    ddsREG: TDataSource;
    fqrREG: TFDQuery;
    dcbEMP: TDBLookupComboBox;
    fqrEMP: TFDQuery;
    ddsEMP: TDataSource;
    Panel3: TPanel;
    pgcIMP: TPageControl;
    tshIMP: TTabSheet;
    dgrIMP: TDBGrid;
    tshREG: TTabSheet;
    dgrREG: TDBGrid;
    fqrIMPEMP_CODIGO: TStringField;
    fqrIMPID: TIntegerField;
    fqrIMPDATA: TDateField;
    fqrREGEMP_CODIGO: TStringField;
    fqrREGID: TIntegerField;
    fqrREGPROTOCOLO: TStringField;
    fqrREGDATACADASTRO: TSQLTimeStampField;
    fqrREGDESPACHANTE: TFloatField;
    fqrREGDISTRIBUIDOR: TFloatField;
    fqrREGVALORCARTORIO: TFloatField;
    fqrREGDAJ: TFloatField;
    fqrREGVALORTOTALCUSTAS: TFloatField;
    fqrREGCONVENIO: TStringField;
    fqrREGCUSTASFECHADAS: TIntegerField;
    fqrREGVALORXIMENESGESTAO: TFloatField;
    fqrREGVALORXIMENESAUT: TFloatField;
    fqrREGVALORXIMENESREC: TFloatField;
    fqrREGVALORXIMENESOUTROS: TFloatField;
    fqrREGREPRESENTANTE: TStringField;
    fqrREGVALORXIMENES: TFloatField;
    fqrREGIMP_ID: TIntegerField;
    procedure sbtCaminhoArquivoClick(Sender: TObject);
    procedure btnImportarClick(Sender: TObject);
    procedure btnSairClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure btnDesfazerIMPClick(Sender: TObject);
    procedure tshREGShow(Sender: TObject);
  private
    procedure AtualizarQueries;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmImportacao: TfrmImportacao;

implementation

uses
  KrImportador, uUtils, uMain, uFuncoesIni, uDBUtils, uMensagem;

{$R *.dfm}

procedure TfrmImportacao.btnImportarClick(Sender: TObject);
begin
  if dcbEMP.KeyValue = null then
  begin
    ShowMessage('Por favor selecione uma Empresa');
    TControlUtils.TryFocus(dcbEMP);
  end
  else
  begin
    TImportador.ImportarArquivo(dcbEMP.KeyValue, edtCaminhoArquivo.Text);
    AtualizarQueries;
  end;
end;

procedure TfrmImportacao.sbtCaminhoArquivoClick(Sender: TObject);
begin
  edtCaminhoArquivo.Text := TUtilArquivo.GetCaminhoArquivo(edtCaminhoArquivo.Text);
end;

procedure TfrmImportacao.tshREGShow(Sender: TObject);
begin
  inherited;
  if not fqrIMP.Eof then
    fqrREG.Open(' SELECT * FROM REG WHERE REG.EMP_CODIGO = ' + (fqrIMP.FieldByName('EMP_CODIGO').AsString).QuotedString +
                ' AND REG.IMP_ID = ' + fqrIMP.FieldByName('ID').AsString);
end;

procedure TfrmImportacao.btnSairClick(Sender: TObject);
begin
  TFuncoesIni.GravarIni('CONFIG', 'FileName', edtCaminhoArquivo.Text);
  Sair;
end;

procedure TfrmImportacao.btnDesfazerIMPClick(Sender: TObject);
begin
  inherited;
  if TMensagem.Confirmar('Deseja desfazer a importação?') then
  begin
    TLeitorCSV.DesfazerImportacao(fqrIMP.FieldByName('EMP_Codigo').AsString, fqrIMP.FieldByName('ID').AsInteger);
    ShowMessage('Importação desfeita!');
    AtualizarQueries;
  end
  else
    ShowMessage('Operação cancelada!');
end;

procedure TfrmImportacao.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  inherited;
  Action := caFree;
end;

procedure TfrmImportacao.FormCreate(Sender: TObject);
begin
  inherited;
  pgcIMP.ActivePage := tshIMP;
  edtCaminhoArquivo.Text := TFuncoesIni.LerIni('CONFIG', 'FileName', ExtractFilePath(ParamStr(0)));
  dcbEMP.KeyValue := TFuncoesIni.LerIni('CONFIG', 'Empresa', ExtractFilePath(ParamStr(0)));
  AtualizarQueries;
  fqrEMP.Open;
end;

procedure TfrmImportacao.AtualizarQueries;
begin
  TDBUtils.RefreshQuery(fqrIMP);
  TDBUtils.RefreshQuery(fqrREG);
end;

end.
